name: Release Build artifacts to winget

on:
  workflow_call:
    inputs:
      releaseTag:
        required: true
        type: string
  workflow_dispatch:
    inputs:
      releaseTag:
        description: 'Release tag name'
        required: true
        type: string

jobs:
  publish-winget:
    name: Publish on winget repo
    runs-on: windows-latest
    needs: [build-msi]
    steps:
      - name: Get download url for msi artifacts
        id: get-release-assets
        uses: actions/github-script@v6
        with:
          script: |
            const query =`query($owner:String!, $name:String!, $tag:String!) {
              repository(owner:$owner, name:$name){
                release(tagName: $tag) {
                    releaseAssets(first:20) {
                      nodes {
                        name
                        downloadUrl
                      }
                  }
                }
              }
            }`;
            const variables = {
              owner: context.repo.owner,
              name: context.repo.repo
              tag: {{ inputs.releaseTag }}
            }
            return await github.graphql(query, variables)
      - name: Submit package to Windows Package Manager Community Repository
        id: submit-winget
        run: |
          iwr https://aka.ms/wingetcreate/latest -OutFile wingetcreate.exe
          $releaseAssets = (ConvertFrom-Json $env:RELEASE_ASSETS).data.repository.release.releaseAssets.nodes
          $installerUrl = $releaseAssets | Where-Object -Property name -match '^Cryptomator-.*\.msi$' | Select -ExpandProperty downloadUrl -First 1
          .\wingetcreate.exe update Cryptomator.Cryptomator -s -v $env:RELEASE_TAG -u $installerUrl -t ${{ secrets.CRYPTOBOT_WINGET_TOKEN }}
        shell: pwsh
        env:
          RELEASE_ASSETS: steps.get-release-assets.outputs.result
          RELEASE_TAG: inputs.releaseTag
